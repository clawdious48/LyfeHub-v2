<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Kanban Board</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/forms-mobile.css">
</head>
<body class="profile-page">
    <div class="profile-container">
        <!-- Header -->
        <div class="profile-header">
            <a href="/" class="back-link">
                ‚Üê Back to Board
            </a>
            <h1 class="settings-title">Settings</h1>
        </div>
        
        <!-- Account Info -->
        <div class="profile-card">
            <h2>Account</h2>
            <div class="profile-info">
                <div class="profile-field">
                    <span class="profile-field-label">Email</span>
                    <span id="display-email" class="profile-field-value">...</span>
                </div>
                <div class="profile-field">
                    <span class="profile-field-label">Name</span>
                    <span id="display-name" class="profile-field-value">...</span>
                </div>
            </div>
            <div style="margin-top: 1rem;">
                <a href="/about.html" class="btn btn-secondary">Edit Profile</a>
            </div>
        </div>
        
        <!-- Change Password -->
        <div class="profile-card">
            <h2>Change Password</h2>
            
            <form id="password-form">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input 
                        type="password" 
                        id="current-password" 
                        autocomplete="current-password"
                        required
                    >
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input 
                        type="password" 
                        id="new-password" 
                        placeholder="At least 8 characters"
                        autocomplete="new-password"
                        minlength="8"
                        required
                    >
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm New Password</label>
                    <input 
                        type="password" 
                        id="confirm-password" 
                        autocomplete="new-password"
                        required
                    >
                </div>
                <div id="password-error" class="auth-error"></div>
                <div id="password-success" class="auth-success"></div>
                <button type="submit" class="btn btn-primary">
                    Update Password
                </button>
            </form>
        </div>
        
        <!-- Danger Zone -->
        
        <!-- API Keys -->
        <div class="profile-card">
            <h2>API Keys</h2>
            <p class="text-muted" style="margin-bottom: 1rem;">Create API keys to connect external tools and agents.</p>
            
            <div id="api-keys-list" style="margin-bottom: 1rem;">
                <p class="text-muted">Loading...</p>
            </div>
            
            <div style="border-top: 1px solid #333; padding-top: 1rem; margin-top: 1rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Create New Key</h3>
                <form id="create-key-form">
                    <div class="form-group">
                        <label for="key-name">Key Name</label>
                        <input type="text" id="key-name" placeholder="e.g., My Agent" required>
                    </div>
                    <div class="form-group">
                        <label for="key-expires">Expires (optional)</label>
                        <input type="date" id="key-expires">
                    </div>
                    <div id="key-error" class="auth-error"></div>
                    <button type="submit" class="btn btn-primary">Generate Key</button>
                </form>
            </div>
            
            <div id="new-key-display" style="display: none; margin-top: 1rem; padding: 1rem; background: #1a1a2e; border-radius: 8px; border: 2px solid #00aaff;">
                <p style="color: #00aaff; font-weight: bold; margin-bottom: 0.75rem; font-size: 0.95rem;">‚ö†Ô∏è Copy this key now - it won't be shown again!</p>
                <code id="new-key-value" style="display: block; padding: 0.75rem; background: #000; border-radius: 4px; word-break: break-all; margin-bottom: 1rem; font-size: 0.8rem; overflow-x: auto; user-select: all; -webkit-user-select: all; line-height: 1.4;"></code>
                <button type="button" onclick="copyKey()" style="display: block; width: 100%; padding: 0.875rem; background: #00aaff; color: #000; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer;">üìã Tap to Copy Key</button>
                <p id="copy-confirm" style="display: none; text-align: center; color: #00ff88; margin-top: 0.5rem; font-weight: bold;">‚úÖ Copied!</p>
            </div>
        </div>
        <!-- Employee Management (management only) -->
        <div class="profile-card" id="employee-section" style="display: none;">
            <h2>Employee Management</h2>
            <p class="text-muted" style="margin-bottom: 1rem;">Manage team members and their roles.</p>

            <div id="employees-list" style="margin-bottom: 1rem;">
                <p class="text-muted">Loading...</p>
            </div>

            <div style="border-top: 1px solid #333; padding-top: 1rem; margin-top: 1rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.75rem;">Add Employee</h3>
                <form id="add-employee-form">
                    <div class="form-group">
                        <label for="emp-name">Name</label>
                        <input type="text" id="emp-name" placeholder="Full name" required>
                    </div>
                    <div class="form-group">
                        <label for="emp-email">Email</label>
                        <input type="email" id="emp-email" placeholder="employee@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="emp-password">Temporary Password</label>
                        <input type="password" id="emp-password" placeholder="At least 8 characters" minlength="8" required>
                    </div>
                    <div class="form-group">
                        <label for="emp-role">Role</label>
                        <select id="emp-role" required>
                            <option value="field_tech">Field Tech</option>
                            <option value="estimator">Estimator</option>
                            <option value="project_manager">Project Manager</option>
                            <option value="office_coordinator">Office Coordinator</option>
                            <option value="management">Management</option>
                        </select>
                    </div>
                    <div id="emp-error" class="auth-error"></div>
                    <div id="emp-success" class="auth-success"></div>
                    <button type="submit" class="btn btn-primary">Add Employee</button>
                </form>
            </div>
        </div>

        <div class="profile-card danger-zone">
            <h2>Session</h2>
            <p class="text-muted" style="margin-bottom: 1rem;">Sign out of your account on this device.</p>
            <button id="logout-btn" class="btn btn-danger">
                Sign Out
            </button>
        </div>
    </div>
    
    <script src="js/particles.js"></script>
    <script src="js/api.js"></script>
    <script>
        // Global auth check - redirect to login on 401
        async function checkAuth() {
            try {
                const res = await fetch("/api/users/me", { credentials: "include" });
                if (res.status === 401) {
                    window.location.href = "/login.html";
                    return false;
                }
                return await res.json();
            } catch (e) {
                window.location.href = "/login.html";
                return false;
            }
        }
        checkAuth();

        // Load user info
        async function loadUser() {
            try {
                const result = await api.getProfile();
                window.currentUser = result.user || {};
                document.getElementById('display-email').textContent = result.user.email;
                document.getElementById('display-name').textContent = result.user.name;
                // Show employee section for management only
                const roles = Array.isArray(result.user.role) ? result.user.role : [result.user.role];
                if (roles.includes('management')) {
                    document.getElementById('employee-section').style.display = '';
                    loadEmployees();
                }
            } catch (err) {
                window.location.href = '/login.html';
            }
        }
        
        // Change password form
        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorEl = document.getElementById('password-error');
            const successEl = document.getElementById('password-success');
            errorEl.textContent = '';
            successEl.textContent = '';
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                errorEl.textContent = 'New passwords do not match';
                return;
            }
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Updating...';
            
            try {
                await api.changePassword(currentPassword, newPassword);
                successEl.textContent = 'Password changed successfully';
                e.target.reset();
            } catch (err) {
                errorEl.textContent = err.message || 'Failed to change password';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Update Password';
            }
        });
        
        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await api.logout();
            } catch (e) {}
            document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";
            document.cookie = "jwt=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";
            document.cookie = "session=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";
            window.location.href = '/login.html';
        });
        
        const roleLabels = {
            field_tech: 'Field Tech',
            estimator: 'Estimator',
            project_manager: 'Project Manager',
            office_coordinator: 'Office Coordinator',
            management: 'Management'
        };

        // Track which employee checkboxes are selected
        let selectedEmployeeIds = new Set();

        async function loadEmployees() {
            const container = document.getElementById('employees-list');
            selectedEmployeeIds.clear();
            updateBulkDeleteBtn();
            try {
                const res = await api.getEmployees();
                const employees = res.employees || res || [];

                if (!employees.length) {
                    container.innerHTML = '<p class="text-muted">No employees yet.</p>';
                    return;
                }

                // Filter out current user from the list (can't delete yourself)
                const currentUserId = window.currentUser?.id;

                container.innerHTML = `
                    <div id="bulk-delete-bar" style="display: none; margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); border-radius: 6px; display: none; align-items: center; gap: 0.75rem;">
                        <span id="bulk-delete-count" style="font-size: 0.85rem;">0 selected</span>
                        <button class="btn btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.8rem; margin-left: auto;" onclick="bulkDeleteEmployees()">Delete Selected</button>
                    </div>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid #333; text-align: left;">
                                <th style="padding: 0.5rem; width: 32px;">
                                    <input type="checkbox" id="emp-select-all" onchange="toggleAllEmployees(this.checked)" title="Select all">
                                </th>
                                <th style="padding: 0.5rem;">Name</th>
                                <th style="padding: 0.5rem;">Email</th>
                                <th style="padding: 0.5rem;">Role</th>
                                <th style="padding: 0.5rem;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${employees.map(emp => {
                                const isSelf = emp.id === currentUserId;
                                return `
                                <tr style="border-bottom: 1px solid #222;" data-emp-id="${escHtml(emp.id)}">
                                    <td style="padding: 0.5rem;">
                                        ${isSelf ? '' : `<input type="checkbox" class="emp-checkbox" data-id="${escHtml(emp.id)}" onchange="toggleEmployeeSelect('${escHtml(emp.id)}', this.checked)">`}
                                    </td>
                                    <td style="padding: 0.5rem;">${escHtml(emp.name || '')}${isSelf ? ' <span style="color: #888; font-size: 0.75rem;">(you)</span>' : ''}</td>
                                    <td style="padding: 0.5rem; color: #888;">${escHtml(emp.email || '')}</td>
                                    <td style="padding: 0.5rem;">
                                        <select onchange="updateEmployeeRole('${escHtml(emp.id)}', this.value)" style="background: #1a1a2e; color: #fff; border: 1px solid #333; border-radius: 4px; padding: 0.25rem;">
                                            ${Object.entries(roleLabels).map(([val, label]) =>
                                                `<option value="${val}" ${emp.role === val ? 'selected' : ''}>${label}</option>`
                                            ).join('')}
                                        </select>
                                    </td>
                                    <td style="padding: 0.5rem;">
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.8rem; margin-right: 0.25rem;" onclick="resetEmployeePassword('${escHtml(emp.id)}', '${escHtml(emp.name || '')}')">Reset PW</button>
                                        ${isSelf ? '' : `<button class="btn btn-danger" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;" onclick="deleteEmployee('${escHtml(emp.id)}', '${escHtml(emp.name || '')}')">Delete</button>`}
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                container.innerHTML = '<p class="text-muted">Failed to load employees.</p>';
            }
        }

        function escHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function toggleEmployeeSelect(empId, checked) {
            if (checked) {
                selectedEmployeeIds.add(empId);
            } else {
                selectedEmployeeIds.delete(empId);
            }
            updateBulkDeleteBtn();
        }

        function toggleAllEmployees(checked) {
            selectedEmployeeIds.clear();
            document.querySelectorAll('.emp-checkbox').forEach(cb => {
                cb.checked = checked;
                if (checked) selectedEmployeeIds.add(cb.dataset.id);
            });
            updateBulkDeleteBtn();
        }

        function updateBulkDeleteBtn() {
            const bar = document.getElementById('bulk-delete-bar');
            const countEl = document.getElementById('bulk-delete-count');
            if (!bar) return;
            if (selectedEmployeeIds.size > 0) {
                bar.style.display = 'flex';
                countEl.textContent = `${selectedEmployeeIds.size} selected`;
            } else {
                bar.style.display = 'none';
            }
        }

        async function bulkDeleteEmployees() {
            const count = selectedEmployeeIds.size;
            if (count === 0) return;
            if (!confirm(`Delete ${count} employee${count > 1 ? 's' : ''}? This cannot be undone.`)) return;
            try {
                const result = await api.bulkDeleteEmployees(Array.from(selectedEmployeeIds));
                const deletedCount = result.deleted?.length || 0;
                const skippedCount = result.skipped?.length || 0;
                if (skippedCount > 0) {
                    alert(`Deleted ${deletedCount}, skipped ${skippedCount} (${result.skipped.map(s => s.reason).join(', ')})`);
                }
                loadEmployees();
            } catch (err) {
                alert('Failed to delete employees: ' + (err.message || err));
            }
        }

        async function updateEmployeeRole(empId, newRole) {
            try {
                await api.updateEmployee(empId, { role: newRole });
            } catch (err) {
                alert('Failed to update role: ' + (err.message || err));
                loadEmployees();
            }
        }

        async function resetEmployeePassword(empId, name) {
            const newPw = prompt(`Enter new password for ${name} (min 8 chars):`);
            if (!newPw || newPw.length < 8) {
                if (newPw !== null) alert('Password must be at least 8 characters');
                return;
            }
            try {
                await api.updateEmployee(empId, { password: newPw });
                alert('Password reset successfully');
            } catch (err) {
                alert('Failed to reset password: ' + (err.message || err));
            }
        }

        async function deleteEmployee(empId, name) {
            if (!confirm(`Delete employee "${name}"? This cannot be undone.`)) return;
            try {
                await api.deleteEmployee(empId);
                loadEmployees();
            } catch (err) {
                alert('Failed to delete employee: ' + (err.message || err));
            }
        }

        document.getElementById('add-employee-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorEl = document.getElementById('emp-error');
            const successEl = document.getElementById('emp-success');
            errorEl.textContent = '';
            successEl.textContent = '';

            const data = {
                name: document.getElementById('emp-name').value,
                email: document.getElementById('emp-email').value,
                password: document.getElementById('emp-password').value,
                role: document.getElementById('emp-role').value
            };

            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Adding...';

            try {
                await api.createEmployee(data);
                successEl.textContent = 'Employee added successfully';
                e.target.reset();
                loadEmployees();
            } catch (err) {
                errorEl.textContent = err.message || 'Failed to add employee';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add Employee';
            }
        });

        loadUser();

        // API Keys functions
        let currentNewKey = '';
        
        let userRole = null;
        
        async function loadApiKeys() {
            const container = document.getElementById("api-keys-list");
            try {
                const res = await fetch("/api/api-keys", { credentials: "include" });
                const data = await res.json();
                userRole = data.role || null;
                
                if (!data.keys || data.keys.length === 0) {
                    container.innerHTML = "<p class=\"text-muted\">No API keys yet.</p>";
                    return;
                }
                
                const isManagement = Array.isArray(userRole) ? userRole.includes("management") : userRole === "management";
                
                container.innerHTML = data.keys.map(function(key) {
                    var escapedId = key.id.replace(/"/g, "&quot;");
                    var html = "<div ";
                    if (isManagement) {
                        html += "onclick=\"copyExistingKey(&apos;" + escapedId + "&apos;, this)\" ";
                        html += "style=\"display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #1a1a2e; border-radius: 6px; margin-bottom: 0.5rem; cursor: pointer; border: 1px solid transparent; transition: border-color 0.2s;\" ";
                        html += "onmouseover=\"this.style.borderColor=&apos;#00aaff&apos;\" onmouseout=\"this.style.borderColor=&apos;transparent&apos;\"";
                    } else {
                        html += "style=\"display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #1a1a2e; border-radius: 6px; margin-bottom: 0.5rem;\"";
                    }
                    html += ">";
                    html += "<div>";
                    html += "<strong>" + (key.name || "Unnamed") + "</strong>";
                    html += "<span style=\"color: #666; margin-left: 0.5rem;\">" + (key.keyPrefix || "") + "...</span>";
                    if (isManagement) html += "<br><span class=\"copy-hint\" style=\"color: #00aaff; font-size: 0.75rem;\">Click to copy full key</span>";
                    if (key.isExpired) html += "<span style=\"color: #ff4444; margin-left: 0.5rem;\">Expired</span>";
                    if (key.expiresAt) html += "<span style=\"color: #888; margin-left: 0.5rem;\">Expires: " + new Date(key.expiresAt).toLocaleDateString() + "</span>";
                    html += "</div>";
                    html += "<button class=\"btn btn-danger\" style=\"padding: 0.25rem 0.5rem; font-size: 0.8rem; flex-shrink: 0;\" onclick=\"event.stopPropagation(); revokeKey(&apos;" + escapedId + "&apos;)\">Revoke</button>";
                    html += "</div>";
                    return html;
                }).join("");
            } catch (err) {
                container.innerHTML = "<p class=\"text-muted\">Failed to load keys.</p>";
                console.error("loadApiKeys error:", err);
            }
        }
        
        async function copyExistingKey(keyId, el) {
            try {
                const res = await fetch('/api/api-keys/' + keyId + '/full', { credentials: 'include' });
                if (!res.ok) {
                    const data = await res.json();
                    alert(data.error || 'Could not retrieve key');
                    return;
                }
                const data = await res.json();
                await navigator.clipboard.writeText(data.key);
                const orig = el.style.borderColor;
                el.style.borderColor = '#00ff88';
                const hint = el.querySelector('span[style*="00aaff"]');
                if (hint) { hint.textContent = '‚úÖ Copied!'; hint.style.color = '#00ff88'; }
                setTimeout(() => { 
                    el.style.borderColor = 'transparent';
                    if (hint) { hint.textContent = 'Tap to copy full key'; hint.style.color = '#00aaff'; }
                }, 2000);
            } catch (err) {
                alert('Failed to copy key');
            }
        }
        
        document.getElementById('create-key-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorEl = document.getElementById('key-error');
            errorEl.textContent = '';
            
            const name = document.getElementById('key-name').value;
            const expires = document.getElementById('key-expires').value;
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Generating...';
            
            try {
                const res = await fetch('/api/api-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name, expiresAt: expires || null })
                });
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error);
                
                currentNewKey = data.key.key;
                document.getElementById('new-key-value').textContent = currentNewKey;
                document.getElementById('new-key-display').style.display = 'block';
                e.target.reset();
                loadApiKeys();
            } catch (err) {
                errorEl.textContent = err.message || 'Failed to create key';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Key';
            }
        });
        
        async function revokeKey(keyId) {
            if (!confirm('Revoke this API key? Any tools using it will stop working.')) return;
            try {
                await fetch('/api/api-keys/' + keyId, { method: 'DELETE', credentials: 'include' });
                loadApiKeys();
            } catch (err) {
                alert('Failed to revoke key');
            }
        }
        
        function copyKey() {
            navigator.clipboard.writeText(currentNewKey);
            var c=document.getElementById('copy-confirm');c.style.display='block';setTimeout(function(){c.style.display='none'},3000);
        }
        
        loadApiKeys();
        // API Keys functions loaded
    </script>
</body>
</html>
