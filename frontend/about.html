<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - LyfeHub</title>
    <link rel="stylesheet" href="css/theme-tokens.css">
    <link rel="stylesheet" href="css/theme-overrides.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/forms-mobile.css">
    <link rel="stylesheet" href="css/apex-theme.css">
    <link rel="stylesheet" href="css/dark-mode.css">
    <script src="js/theme.js"></script>
</head>
<body class="profile-page">
    <div class="profile-container">
        <!-- Header -->
        <div class="profile-header">
            <a href="/" class="back-link">← Back to Board</a>
            <a href="/settings.html" class="btn btn-icon" title="Settings">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                </svg>
            </a>
        </div>

        <!-- Profile Completion -->
        <div class="profile-completion" id="profile-completion"></div>

        <!-- Identity Card -->
        <div class="profile-card about-card">
            <div class="about-header">
                <div class="avatar-wrapper">
                    <img id="gravatar-img" class="gravatar-avatar" alt="Avatar" style="display:none;">
                    <div class="profile-avatar" id="fallback-avatar">?</div>
                </div>
                <div class="about-welcome">
                    <h1 id="user-name">...</h1>
                    <span class="role-badge" id="user-role"></span>
                    <p class="text-muted" id="user-email">...</p>
                </div>
            </div>
        </div>

        <form id="edit-profile-form">
            <!-- Profile Card -->
            <div class="profile-card">
                <h2>Contact Info</h2>
                <div class="form-group">
                    <label for="edit-name">Display Name</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-email">Email</label>
                    <input type="email" id="edit-email" disabled>
                    <small class="text-muted">Set at signup — change in Settings</small>
                </div>
                <div class="form-group">
                    <label for="edit-phone">Phone</label>
                    <input type="tel" id="edit-phone" placeholder="(801) 555-0123">
                </div>
            </div>

            <!-- Emergency Contact Card -->
            <div class="profile-card emergency-card">
                <h2>Emergency Contact</h2>
                <div class="form-group">
                    <label for="edit-ec-name">Contact Name</label>
                    <input type="text" id="edit-ec-name" placeholder="Jane Doe">
                </div>
                <div class="form-group">
                    <label for="edit-ec-phone">Contact Phone</label>
                    <input type="tel" id="edit-ec-phone" placeholder="(801) 555-0456">
                </div>
            </div>

            <!-- Activity Card -->
            <div class="profile-card">
                <h2>Your Activity</h2>
                <div class="profile-info">
                    <div class="profile-field">
                        <span class="profile-field-label">Member since</span>
                        <span id="member-since" class="profile-field-value">...</span>
                    </div>
                </div>
            </div>

            <!-- Save + Messages -->
            <div id="edit-error" class="auth-error"></div>
            <div id="edit-success" class="auth-success"></div>

            <!-- CTA -->
            <div class="get-started">
                <button type="submit" class="btn btn-primary btn-full" id="save-btn">
                    Save & Continue →
                </button>
            </div>
        </form>
    </div>

    <script src="js/api.js"></script>
    <script>
        // Lightweight MD5 (RFC 1321) — for Gravatar hash only
        function md5(str) {
            function cmn(q,a,b,x,s,t) { a = (a + q + (x >>> 0) + t) | 0; return (((a << s) | (a >>> (32 - s))) + b) | 0; }
            function ff(a,b,c,d,x,s,t) { return cmn((b & c) | (~b & d), a, b, x, s, t); }
            function gg(a,b,c,d,x,s,t) { return cmn((b & d) | (c & ~d), a, b, x, s, t); }
            function hh(a,b,c,d,x,s,t) { return cmn(b ^ c ^ d, a, b, x, s, t); }
            function ii(a,b,c,d,x,s,t) { return cmn(c ^ (b | ~d), a, b, x, s, t); }
            function md5cycle(x, k) {
                var a = x[0], b = x[1], c = x[2], d = x[3];
                a = ff(a,b,c,d,k[0],7,-680876936);d = ff(d,a,b,c,k[1],12,-389564586);c = ff(c,d,a,b,k[2],17,606105819);b = ff(b,c,d,a,k[3],22,-1044525330);
                a = ff(a,b,c,d,k[4],7,-176418897);d = ff(d,a,b,c,k[5],12,1200080426);c = ff(c,d,a,b,k[6],17,-1473231341);b = ff(b,c,d,a,k[7],22,-45705983);
                a = ff(a,b,c,d,k[8],7,1770035416);d = ff(d,a,b,c,k[9],12,-1958414417);c = ff(c,d,a,b,k[10],17,-42063);b = ff(b,c,d,a,k[11],22,-1990404162);
                a = ff(a,b,c,d,k[12],7,1804603682);d = ff(d,a,b,c,k[13],12,-40341101);c = ff(c,d,a,b,k[14],17,-1502002290);b = ff(b,c,d,a,k[15],22,1236535329);
                a = gg(a,b,c,d,k[1],5,-165796510);d = gg(d,a,b,c,k[6],9,-1069501632);c = gg(c,d,a,b,k[11],14,643717713);b = gg(b,c,d,a,k[0],20,-373897302);
                a = gg(a,b,c,d,k[5],5,-701558691);d = gg(d,a,b,c,k[10],9,38016083);c = gg(c,d,a,b,k[15],14,-660478335);b = gg(b,c,d,a,k[4],20,-405537848);
                a = gg(a,b,c,d,k[9],5,568446438);d = gg(d,a,b,c,k[14],9,-1019803690);c = gg(c,d,a,b,k[3],14,-187363961);b = gg(b,c,d,a,k[8],20,1163531501);
                a = gg(a,b,c,d,k[13],5,-1444681467);d = gg(d,a,b,c,k[2],9,-51403784);c = gg(c,d,a,b,k[7],14,1735328473);b = gg(b,c,d,a,k[12],20,-1926607734);
                a = hh(a,b,c,d,k[5],4,-378558);d = hh(d,a,b,c,k[8],11,-2022574463);c = hh(c,d,a,b,k[11],16,1839030562);b = hh(b,c,d,a,k[14],23,-35309556);
                a = hh(a,b,c,d,k[1],4,-1530992060);d = hh(d,a,b,c,k[4],11,1272893353);c = hh(c,d,a,b,k[7],16,-155497632);b = hh(b,c,d,a,k[10],23,-1094730640);
                a = hh(a,b,c,d,k[13],4,681279174);d = hh(d,a,b,c,k[0],11,-358537222);c = hh(c,d,a,b,k[3],16,-722521979);b = hh(b,c,d,a,k[6],23,76029189);
                a = hh(a,b,c,d,k[9],4,-640364487);d = hh(d,a,b,c,k[12],11,-421815835);c = hh(c,d,a,b,k[15],16,530742520);b = hh(b,c,d,a,k[2],23,-995338651);
                a = ii(a,b,c,d,k[0],6,-198630844);d = ii(d,a,b,c,k[7],10,1126891415);c = ii(c,d,a,b,k[14],15,-1416354905);b = ii(b,c,d,a,k[5],21,-57434055);
                a = ii(a,b,c,d,k[12],6,1700485571);d = ii(d,a,b,c,k[3],10,-1894986606);c = ii(c,d,a,b,k[10],15,-1051523);b = ii(b,c,d,a,k[1],21,-2054922799);
                a = ii(a,b,c,d,k[8],6,1873313359);d = ii(d,a,b,c,k[15],10,-30611744);c = ii(c,d,a,b,k[6],15,-1560198380);b = ii(b,c,d,a,k[13],21,1309151649);
                a = ii(a,b,c,d,k[4],6,-145523070);d = ii(d,a,b,c,k[11],10,-1120210379);c = ii(c,d,a,b,k[2],15,718787259);b = ii(b,c,d,a,k[9],21,-343485551);
                x[0] = (x[0] + a) | 0; x[1] = (x[1] + b) | 0; x[2] = (x[2] + c) | 0; x[3] = (x[3] + d) | 0;
            }
            function md5blk(s) {
                var md5blks = [], i;
                for (i = 0; i < 64; i += 4) md5blks[i >> 2] = s.charCodeAt(i) + (s.charCodeAt(i+1) << 8) + (s.charCodeAt(i+2) << 16) + (s.charCodeAt(i+3) << 24);
                return md5blks;
            }
            var n = str.length, state = [1732584193, -271733879, -1732584194, 271733878], i;
            for (i = 64; i <= n; i += 64) md5cycle(state, md5blk(str.substring(i - 64, i)));
            str = str.substring(i - 64);
            var tail = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
            for (i = 0; i < str.length; i++) tail[i >> 2] |= str.charCodeAt(i) << ((i % 4) << 3);
            tail[i >> 2] |= 0x80 << ((i % 4) << 3);
            if (i > 55) { md5cycle(state, tail); tail = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; }
            tail[14] = n * 8;
            md5cycle(state, tail);
            var hex = '0123456789abcdef', s = '';
            for (i = 0; i < 4; i++) for (var j = 0; j < 4; j++) s += hex.charAt((state[i] >> (j * 8 + 4)) & 0xF) + hex.charAt((state[i] >> (j * 8)) & 0xF);
            return s;
        }

        const ROLE_LABELS = {
            developer: 'Developer',
            management: 'Management',
            office_coordinator: 'Office Coordinator',
            project_manager: 'Project Manager',
            estimator: 'Estimator',
            field_tech: 'Field Tech'
        };

        let currentUser = null;

        function updateCompletion(user) {
            const fields = [user.name, user.phone, user.emergency_contact_name, user.emergency_contact_phone];
            const filled = fields.filter(f => f && f.trim()).length;
            const el = document.getElementById('profile-completion');
            el.textContent = 'Profile ' + filled + '/' + fields.length + ' complete';
            el.className = 'profile-completion' + (filled === fields.length ? ' complete' : '');
        }

        async function loadProfile() {
            try {
                const result = await api.getProfile();
                currentUser = result.user;

                // Identity
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('user-role').textContent = ROLE_LABELS[currentUser.role] || 'Field Tech';

                // Gravatar
                const hash = md5(currentUser.email.trim().toLowerCase());
                const img = document.getElementById('gravatar-img');
                const fallback = document.getElementById('fallback-avatar');
                img.src = 'https://gravatar.com/avatar/' + hash + '?d=404&s=120';
                img.onload = function() { img.style.display = ''; fallback.style.display = 'none'; };
                img.onerror = function() { img.style.display = 'none'; fallback.style.display = ''; fallback.textContent = currentUser.name.charAt(0).toUpperCase(); };
                fallback.textContent = currentUser.name.charAt(0).toUpperCase();

                // Form fields
                document.getElementById('edit-name').value = currentUser.name;
                document.getElementById('edit-email').value = currentUser.email;
                document.getElementById('edit-phone').value = currentUser.phone || '';
                document.getElementById('edit-ec-name').value = currentUser.emergency_contact_name || '';
                document.getElementById('edit-ec-phone').value = currentUser.emergency_contact_phone || '';

                // Activity
                document.getElementById('member-since').textContent =
                    new Date(currentUser.created_at).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });

                // Completion indicator
                updateCompletion(currentUser);

                // CTA label — "Save Changes" if profile fields already filled
                if (currentUser.phone || currentUser.emergency_contact_name) {
                    document.getElementById('save-btn').textContent = 'Save Changes';
                }
            } catch (err) {
                window.location.href = '/login.html';
            }
        }

        document.getElementById('edit-profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            var errorEl = document.getElementById('edit-error');
            var successEl = document.getElementById('edit-success');
            errorEl.textContent = '';
            successEl.textContent = '';

            var name = document.getElementById('edit-name').value.trim();
            if (!name) { errorEl.textContent = 'Name is required'; return; }

            var btn = document.getElementById('save-btn');
            var wasFirstVisit = btn.textContent.indexOf('Continue') !== -1;
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                var result = await api.updateProfile({
                    name: name,
                    phone: document.getElementById('edit-phone').value.trim(),
                    emergency_contact_name: document.getElementById('edit-ec-name').value.trim(),
                    emergency_contact_phone: document.getElementById('edit-ec-phone').value.trim()
                });
                currentUser = result.user;
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('fallback-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
                updateCompletion(currentUser);

                successEl.textContent = 'Profile saved!';
                btn.disabled = false;
                btn.textContent = 'Save Changes';

                if (wasFirstVisit) {
                    setTimeout(function() { window.location.href = '/'; }, 1200);
                } else {
                    setTimeout(function() { successEl.textContent = ''; }, 2000);
                }
            } catch (err) {
                errorEl.textContent = err.message || 'Failed to save';
                btn.disabled = false;
                btn.textContent = wasFirstVisit ? 'Save & Continue →' : 'Save Changes';
            }
        });

        loadProfile();
    </script>
</body>
</html>
